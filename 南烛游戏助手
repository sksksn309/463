-- 南烛游戏助手主脚本
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- 发送聊天消息
local function SendChatMessage(message, teamOnly)
    local ChatService = game:GetService("Chat")
    ChatService.ChatLocal(message, "System", LocalPlayer)
    if teamOnly then
        ChatService.ChatPrivate(message, "System", LocalPlayer, LocalPlayer)
    end
end

-- 创建提示框
local function CreateNotification(text, duration)
    duration = duration or 3
    local notification = Instance.new("TextLabel")
    notification.Name = "GameHelperNotification"
    notification.Text = text
    notification.TextColor3 = Color3.new(1, 1, 1)
    notification.BackgroundColor3 = Color3.new(0, 0, 0)
    notification.BackgroundTransparency = 0.5
    notification.Size = UDim2.new(0.2, 0, 0.05, 0)
    notification.Position = UDim2.new(0.8, 0, 0.9, 0)
    notification.Font = Enum.Font.SourceSansBold
    notification.TextSize = 14
    notification.Parent = PlayerGui
    
    -- 淡出效果
    TweenService:Create(
        notification,
        TweenInfo.new(1, Enum.EasingStyle.Linear),
        {TextTransparency = 1, BackgroundTransparency = 1}
    ):Play()
    
    game.Debris:AddItem(notification, duration)
end

-- 创建卡密系统
local function CreateKeySystem()
    local keyGui = Instance.new("ScreenGui")
    keyGui.Name = "NanzhuKeySystem"
    keyGui.ResetOnSpawn = false
    
    -- 背景遮罩
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.new(0, 0, 0)
    background.BackgroundTransparency = 0.5
    background.BorderSizePixel = 0
    background.Parent = keyGui
    
    -- 主弹窗
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0.5, 0, 0.4, 0)
    mainFrame.Position = UDim2.new(0.25, 0, 0.3, 0)
    mainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = keyGui
    
    -- 标题
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Text = "南烛游戏助手 - 卡密验证"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, 0, 0.2, 0)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 24
    title.Parent = mainFrame
    
    -- 提示文本
    local hintText = Instance.new("TextLabel")
    hintText.Name = "HintText"
    hintText.Text = "获取脚本卡密请加🐧群：123456789"
    hintText.TextColor3 = Color3.new(1, 0.5, 0.5)
    hintText.BackgroundTransparency = 1
    hintText.Size = UDim2.new(1, 0, 0.2, 0)
    hintText.Position = UDim2.new(0, 0, 0.2, 0)
    hintText.Font = Enum.Font.SourceSans
    hintText.TextSize = 16
    hintText.Parent = mainFrame
    
    -- 输入框
    local inputBox = Instance.new("TextBox")
    inputBox.Name = "InputBox"
    inputBox.PlaceholderText = "请输入卡密"
    inputBox.Text = ""
    inputBox.TextColor3 = Color3.new(1, 1, 1)
    inputBox.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    inputBox.Size = UDim2.new(0.8, 0, 0.15, 0)
    inputBox.Position = UDim2.new(0.1, 0, 0.45, 0)
    inputBox.Font = Enum.Font.SourceSans
    inputBox.TextSize = 18
    inputBox.Parent = mainFrame
    
    -- 提交按钮
    local submitButton = Instance.new("TextButton")
    submitButton.Name = "SubmitButton"
    submitButton.Text = "验证"
    submitButton.TextColor3 = Color3.new(1, 1, 1)
    submitButton.BackgroundColor3 = Color3.new(0.2, 0.5, 0.2)
    submitButton.Size = UDim2.new(0.5, 0, 0.15, 0)
    submitButton.Position = UDim2.new(0.25, 0, 0.65, 0)
    submitButton.Font = Enum.Font.SourceSansBold
    submitButton.TextSize = 18
    submitButton.Parent = mainFrame
    
    -- 使弹窗可拖动
    local dragging = false
    local dragStartPos = Vector2.new(0, 0)
    local frameStartPos = Vector2.new(0, 0)
    
    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStartPos = Vector2.new(input.Position.X, input.Position.Y)
            frameStartPos = Vector2.new(mainFrame.Position.X.Offset, mainFrame.Position.Y.Offset)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = Vector2.new(input.Position.X, input.Position.Y) - dragStartPos
            mainFrame.Position = UDim2.new(0, frameStartPos.X + delta.X, 0, frameStartPos.Y + delta.Y)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    -- 验证逻辑
    submitButton.MouseButton1Click:Connect(function()
        local inputKey = inputBox.Text
        if inputKey == "nznb666" then
            CreateNotification("验证成功，正在加载主界面...", 2)
            wait(2)
            keyGui:Destroy()
            CreateMainPopup()
        else
            CreateNotification("卡密错误，您将被踢出游戏", 2)
            wait(2)
            LocalPlayer:Kick("key wrong")
        end
    end)
    
    keyGui.Parent = PlayerGui
    return keyGui
end

-- 创建主弹窗
local function CreateMainPopup()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "NanzhuGameHelper"
    screenGui.ResetOnSpawn = false
    
    -- 背景遮罩
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.new(0, 0, 0)
    background.BackgroundTransparency = 0.5
    background.BorderSizePixel = 0
    background.Parent = screenGui
    
    -- 主弹窗
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0.4, 0, 0.6, 0)
    mainFrame.Position = UDim2.new(0.3, 0, 0.2, 0)
    mainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    -- 标题
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Text = "南烛游戏助手"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, 0, 0.1, 0)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 20
    title.Parent = mainFrame
    
    -- 关闭按钮
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.BackgroundTransparency = 1
    closeButton.Size = UDim2.new(0.1, 0, 0.1, 0)
    closeButton.Position = UDim2.new(0.9, 0, 0, 0)
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.TextSize = 20
    closeButton.Parent = mainFrame
    
    -- 分类容器
    local categories = Instance.new("ScrollingFrame")
    categories.Name = "Categories"
    categories.BackgroundTransparency = 1
    categories.Size = UDim2.new(1, 0, 0.1, 0)
    categories.Position = UDim2.new(0, 0, 0.1, 0)
    categories.ScrollBarThickness = 5
    categories.AutomaticCanvasSize = Enum.AutomaticSize.X
    categories.CanvasSize = UDim2.new(0, 0, 0, 0)
    categories.Parent = mainFrame
    
    -- 功能按钮容器
    local buttonsFrame = Instance.new("Frame")
    buttonsFrame.Name = "ButtonsFrame"
    buttonsFrame.BackgroundTransparency = 1
    buttonsFrame.Size = UDim2.new(1, 0, 0.7, 0)
    buttonsFrame.Position = UDim2.new(0, 0, 0.2, 0)
    buttonsFrame.Parent = mainFrame
    
    -- 创建分类按钮
    local function CreateCategoryButton(name, positionX)
        local button = Instance.new("TextButton")
        button.Name = name .. "Category"
        button.Text = name
        button.TextColor3 = Color3.new(1, 1, 1)
        button.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
        button.Size = UDim2.new(0.3, 0, 1, 0)
        button.Position = UDim2.new(positionX, 0, 0, 0)
        button.Font = Enum.Font.SourceSansBold
        button.TextSize = 16
        button.Parent = categories
        return button
    end
    
    -- 创建功能按钮
    local function CreateFunctionButton(name, positionY, parent)
        local button = Instance.new("TextButton")
        button.Name = name .. "Button"
        button.Text = name
        button.TextColor3 = Color3.new(1, 1, 1)
        button.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
        button.Size = UDim2.new(0.9, 0, 0.15, 0)
        button.Position = UDim2.new(0.05, 0, positionY, 0)
        button.Font = Enum.Font.SourceSans
        button.TextSize = 16
        button.Parent = parent
        return button
    end
    
    -- 创建分类
    local generalCategory = CreateCategoryButton("通用", 0)
    local espCategory = CreateCategoryButton("ESP", 0.33)
    local feCategory = CreateCategoryButton("FE", 0.66)
    local devCategory = CreateCategoryButton("开发人员", 0.99)
    
    -- 通用分类内容
    local generalButtons = Instance.new("Frame")
    generalButtons.Name = "GeneralButtons"
    generalButtons.BackgroundTransparency = 1
    generalButtons.Size = UDim2.new(1, 0, 1, 0)
    generalButtons.Visible = true
    generalButtons.Parent = buttonsFrame
    
    local invincibleFlightButton = CreateFunctionButton("无敌少侠飞行", 0, generalButtons)
    local noclipButton = CreateFunctionButton("穿墙", 0.2, generalButtons)
    local fastSpinButton = CreateFunctionButton("快速旋转 (速度50)", 0.4, generalButtons)
    local ultraSpinButton = CreateFunctionButton("极速旋转 (速度100)", 0.6, generalButtons)
    local infiniteJumpButton = CreateFunctionButton("无限跳", 0.8, generalButtons)
    
    -- ESP分类内容
    local espButtons = Instance.new("Frame")
    espButtons.Name = "ESPButtons"
    espButtons.BackgroundTransparency = 1
    espButtons.Size = UDim2.new(1, 0, 1, 0)
    espButtons.Visible = false
    espButtons.Parent = buttonsFrame
    
    local drawPlayersButton = CreateFunctionButton("显示绘制", 0, espButtons)
    local outlineButton = CreateFunctionButton("显示人物轮廓", 0.25, espButtons)
    local nameTagsButton = CreateFunctionButton("显示名字", 0.5, espButtons)
    
    -- FE分类内容
    local feButtons = Instance.new("Frame")
    feButtons.Name = "FEButtons"
    feButtons.BackgroundTransparency = 1
    feButtons.Size = UDim2.new(1, 0, 1, 0)
    feButtons.Visible = false
    feButtons.Parent = buttonsFrame
    
    -- 开发人员分类内容
    local devButtons = Instance.new("Frame")
    devButtons.Name = "DevButtons"
    devButtons.BackgroundTransparency = 1
    devButtons.Size = UDim2.new(1, 0, 1, 0)
    devButtons.Visible = false
    devButtons.Parent = buttonsFrame
    
    local mainAuthor = Instance.new("TextLabel")
    mainAuthor.Name = "MainAuthor"
    mainAuthor.Text = "主作者: 南烛"
    mainAuthor.TextColor3 = Color3.new(1, 1, 1)
    mainAuthor.BackgroundTransparency = 1
    mainAuthor.Size = UDim2.new(1, 0, 0.2, 0)
    mainAuthor.Position = UDim2.new(0, 0, 0.2, 0)
    mainAuthor.Font = Enum.Font.SourceSansBold
    mainAuthor.TextSize = 18
    mainAuthor.Parent = devButtons
    
    local subAuthor = Instance.new("TextLabel")
    subAuthor.Name = "SubAuthor"
    subAuthor.Text = "副作者: 深情梦话一"
    subAuthor.TextColor3 = Color3.new(1, 1, 1)
    subAuthor.BackgroundTransparency = 1
    subAuthor.Size = UDim2.new(1, 0, 0.2, 0)
    subAuthor.Position = UDim2.new(0, 0, 0.4, 0)
    subAuthor.Font = Enum.Font.SourceSansBold
    subAuthor.TextSize = 18
    subAuthor.Parent = devButtons
    
    -- 分类切换逻辑
    generalCategory.MouseButton1Click:Connect(function()
        generalButtons.Visible = true
        espButtons.Visible = false
        feButtons.Visible = false
        devButtons.Visible = false
    end)
    
    espCategory.MouseButton1Click:Connect(function()
        generalButtons.Visible = false
        espButtons.Visible = true
        feButtons.Visible = false
        devButtons.Visible = false
    end)
    
    feCategory.MouseButton1Click:Connect(function()
        generalButtons.Visible = false
        espButtons.Visible = false
        feButtons.Visible = true
        devButtons.Visible = false
    end)
    
    devCategory.MouseButton1Click:Connect(function()
        generalButtons.Visible = false
        espButtons.Visible = false
        feButtons.Visible = false
        devButtons.Visible = true
    end)
    
    -- 使弹窗可拖动
    local dragging = false
    local dragStartPos = Vector2.new(0, 0)
    local frameStartPos = Vector2.new(0, 0)
    
    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStartPos = Vector2.new(input.Position.X, input.Position.Y)
            frameStartPos = Vector2.new(mainFrame.Position.X.Offset, mainFrame.Position.Y.Offset)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = Vector2.new(input.Position.X, input.Position.Y) - dragStartPos
            mainFrame.Position = UDim2.new(0, frameStartPos.X + delta.X, 0, frameStartPos.Y + delta.Y)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    -- 按钮功能
    -- 无敌少侠飞行
    invincibleFlightButton.MouseButton1Click:Connect(function()
        loadstring(game:HttpGet("https://rawscripts.net/raw/Universal-Script-Invinicible-Flight-R15-45414"))()
        CreateNotification("无敌少侠飞行已激活")
    end)
    
    -- 穿墙
    local noclipActive = false
    noclipButton.MouseButton1Click:Connect(function()
        noclipActive = not noclipActive
        noclipButton.Text = noclipActive and "穿墙 (已激活)" or "穿墙"
        
        if noclipActive then
            CreateNotification("穿墙已激活")
            
            local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local humanoid = character:WaitForChild("Humanoid")
            
            local noclipLoop
            noclipLoop = RunService.Stepped:Connect(function()
                if not noclipActive then
                    noclipLoop:Disconnect()
                    return
                end
                
                if character then
                    for _, part in pairs(character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        else
            CreateNotification("穿墙已关闭")
        end
    end)
    
    -- 快速旋转
    local fastSpinActive = false
    local fastSpinConnection
    fastSpinButton.MouseButton1Click:Connect(function()
        fastSpinActive = not fastSpinActive
        fastSpinButton.Text = fastSpinActive and "快速旋转 (已激活)" or "快速旋转 (速度50)"
        
        if fastSpinActive then
            CreateNotification("快速旋转已激活")
            
            local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
            
            fastSpinConnection = RunService.Heartbeat:Connect(function()
                if not fastSpinActive then
                    fastSpinConnection:Disconnect()
                    return
                end
                
                if humanoidRootPart then
                    humanoidRootPart.CFrame = humanoidRootPart.CFrame * CFrame.Angles(0, math.rad(50), 0)
                end
            end)
        else
            CreateNotification("快速旋转已关闭")
        end
    end)
    
    -- 极速旋转
    local ultraSpinActive = false
    local ultraSpinConnection
    ultraSpinButton.MouseButton1Click:Connect(function()
        ultraSpinActive = not ultraSpinActive
        ultraSpinButton.Text = ultraSpinActive and "极速旋转 (已激活)" or "极速旋转 (速度100)"
        
        if ultraSpinActive then
            CreateNotification("极速旋转已激活")
            
            local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
            
            ultraSpinConnection = RunService.Heartbeat:Connect(function()
                if not ultraSpinActive then
                    ultraSpinConnection:Disconnect()
                    return
                end
                
                if humanoidRootPart then
                    humanoidRootPart.CFrame = humanoidRootPart.CFrame * CFrame.Angles(0, math.rad(100), 0)
                end
            end)
        else
            CreateNotification("极速旋转已关闭")
        end
    end)
    
    -- 无限跳
    local infiniteJumpActive = false
    local infiniteJumpConnection
    infiniteJumpButton.MouseButton1Click:Connect(function()
        infiniteJumpActive = not infiniteJumpActive
        infiniteJumpButton.Text = infiniteJumpActive and "无限跳 (已激活)" or "无限跳"
        
        if infiniteJumpActive then
            CreateNotification("无限跳已激活")
            
            local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local humanoid = character:WaitForChild("Humanoid")
            
            infiniteJumpConnection = UserInputService.JumpRequest:Connect(function()
                if infiniteJumpActive and humanoid then
                    humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                end
            end)
        else
            CreateNotification("无限跳已关闭")
            if infiniteJumpConnection then
                infiniteJumpConnection:Disconnect()
            end
        end
    end)
    
    -- ESP功能
    local espObjects = {}
    
    -- 显示绘制
    local drawPlayersActive = false
    drawPlayersButton.MouseButton1Click:Connect(function()
        drawPlayersActive = not drawPlayersActive
        drawPlayersButton.Text = drawPlayersActive and "显示绘制 (已激活)" or "显示绘制"
        
        if drawPlayersActive then
            CreateNotification("显示绘制已激活")
            
            local function createLine(player)
                if player == LocalPlayer then return end
                
                local line = Instance.new("LineHandleAdornment")
                line.Name = player.Name .. "Line"
                line.Adornee = workspace.Terrain
                line.Length = 100
                line.Thickness = 2
                line.Color3 = Color3.new(1, 1, 1)
                line.ZIndex = 1
                line.Parent = PlayerGui
                
                espObjects[player] = espObjects[player] or {}
                table.insert(espObjects[player], line)
                
                local character = player.Character
                if character then
                    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                    if humanoidRootPart then
                        line.CFrame = CFrame.new(humanoidRootPart.Position, LocalPlayer.Character.HumanoidRootPart.Position)
                        line.Length = (humanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                    end
                end
                
                local connection
                connection = RunService.Heartbeat:Connect(function()
                    if not drawPlayersActive then
                        connection:Disconnect()
                        return
                    end
                    
                    local character = player.Character
                    if character and LocalPlayer.Character then
                        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                        local localRootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        
                        if humanoidRootPart and localRootPart then
                            line.CFrame = CFrame.new(humanoidRootPart.Position, localRootPart.Position)
                            line.Length = (humanoidRootPart.Position - localRootPart.Position).Magnitude
                        end
                    end
                end)
            end
            
            for _, player in pairs(Players:GetPlayers()) do
                createLine(player)
            end
            
            Players.PlayerAdded:Connect(createLine)
        else
            CreateNotification("显示绘制已关闭")
            for _, objects in pairs(espObjects) do
                for _, obj in ipairs(objects) do
                    if obj:IsA("LineHandleAdornment") then
                        obj:Destroy()
                    end
                end
            end
            espObjects = {}
        end
    end)
    
    -- 显示人物轮廓
    local outlineActive = false
    outlineButton.MouseButton1Click:Connect(function()
        outlineActive = not outlineActive
        outlineButton.Text = outlineActive and "显示人物轮廓 (已激活)" or "显示人物轮廓"
        
        if outlineActive then
            CreateNotification("显示人物轮廓已激活")
            
            local function createOutline(player)
                if player == LocalPlayer then return end
                
                local character = player.Character
                if character then
                    for _, part in pairs(character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            local highlight = Instance.new("Highlight")
                            highlight.Name = player.Name .. "Highlight"
                            highlight.FillTransparency = 1
                            highlight.OutlineColor = Color3.new(1, 1, 1)
                            highlight.OutlineTransparency = 0
                            highlight.Adornee = part
                            highlight.Parent = part
                            
                            espObjects[player] = espObjects[player] or {}
                            table.insert(espObjects[player], highlight)
                        end
                    end
                end
                
                player.CharacterAdded:Connect(function(newChar)
                    for _, part in pairs(newChar:GetDescendants()) do
                        if part:IsA("BasePart") then
                            local highlight = Instance.new("Highlight")
                            highlight.Name = player.Name .. "Highlight"
                            highlight.FillTransparency = 1
                            highlight.OutlineColor = Color3.new(1, 1, 1)
                            highlight.OutlineTransparency = 0
                            highlight.Adornee = part
                            highlight.Parent = part
                            
                            espObjects[player] = espObjects[player] or {}
                            table.insert(espObjects[player], highlight)
                        end
                    end
                end)
            end
            
            for _, player in pairs(Players:GetPlayers()) do
                createOutline(player)
            end
            
            Players.PlayerAdded:Connect(createOutline)
        else
            CreateNotification("显示人物轮廓已关闭")
            for _, objects in pairs(espObjects) do
                for _, obj in ipairs(objects) do
                    if obj:IsA("Highlight") then
                        obj:Destroy()
                    end
                end
            end
            espObjects = {}
        end
    end)
    
    -- 显示名字
    local nameTagsActive = false
    nameTagsButton.MouseButton1Click:Connect(function()
        nameTagsActive = not nameTagsActive
        nameTagsButton.Text = nameTagsActive and "显示名字 (已激活)" or "显示名字"
        
        if nameTagsActive then
            CreateNotification("显示名字已激活")
            
            local function createNameTag(player)
                if player == LocalPlayer then return end
                
                local character = player.Character
                if character then
                    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                    if humanoidRootPart then
                        local billboard = Instance.new("BillboardGui")
                        billboard.Name = player.Name .. "NameTag"
                        billboard.Adornee = humanoidRootPart
                        billboard.Size = UDim2.new(0, 200, 0, 50)
                        billboard.StudsOffset = Vector3.new(0, 3, 0)
                        billboard.AlwaysOnTop = true
                        billboard.Parent = humanoidRootPart
                        
                        local textLabel = Instance.new("TextLabel")
                        textLabel.Name = "NameLabel"
                        textLabel.Text = player.Name
                        textLabel.TextColor3 = Color3.new(1, 1, 1)
                        textLabel.BackgroundTransparency = 1
                        textLabel.Size = UDim2.new(1, 0, 1, 0)
                        textLabel.Font = Enum.Font.SourceSansBold
                        textLabel.TextSize = 18
                        textLabel.Parent = billboard
                        
                        espObjects[player] = espObjects[player] or {}
                        table.insert(espObjects[player], billboard)
                    end
                end
                
                player.CharacterAdded:Connect(function(newChar)
                    local humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = player.Name .. "NameTag"
                    billboard.Adornee = humanoidRootPart
                    billboard.Size = UDim2.new(0, 200, 0, 50)
                    billboard.StudsOffset = Vector3.new(0, 3, 0)
                    billboard.AlwaysOnTop = true
                    billboard.Parent = humanoidRootPart
                    
                    local textLabel = Instance.new("TextLabel")
                    textLabel.Name = "NameLabel"
                    textLabel.Text = player.Name
                    textLabel.TextColor3 = Color3.new(1, 1, 1)
                    textLabel.BackgroundTransparency = 1
                    textLabel.Size = UDim2.new(1, 0, 1, 0)
                    textLabel.Font = Enum.Font.SourceSansBold
                    textLabel.TextSize = 18
                    textLabel.Parent = billboard
                    
                    espObjects[player] = espObjects[player] or {}
                    table.insert(espObjects[player], billboard)
                end)
            end
            
            for _, player in pairs(Players:GetPlayers()) do
                createNameTag(player)
            end
            
            Players.PlayerAdded:Connect(createNameTag)
        else
            CreateNotification("显示名字已关闭")
            for _, objects in pairs(espObjects) do
                for _, obj in ipairs(objects) do
                    if obj:IsA("BillboardGui") then
                        obj:Destroy()
                    end
                end
            end
            espObjects = {}
        end
    end)
    
    -- 开关弹窗
    local popupVisible = true
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleButton"
    toggleButton.Text = "隐藏助手"
    toggleButton.TextColor3 = Color3.new(1, 1, 1)
    toggleButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    toggleButton.Size = UDim2.new(0.2, 0, 0.05, 0)
    toggleButton.Position = UDim2.new(0, 0, 0.95, 0)
    toggleButton.Font = Enum.Font.SourceSans
    toggleButton.TextSize = 14
    toggleButton.Parent = screenGui
    
    toggleButton.MouseButton1Click:Connect(function()
        popupVisible = not popupVisible
        toggleButton.Text = popupVisible and "隐藏助手" or "显示助手"
        mainFrame.Visible = popupVisible
        background.Visible = popupVisible
    end)
    
    -- 关闭脚本
    closeButton.MouseButton1Click:Connect(function()
        CreateNotification("脚本已关闭", 2)
        wait(2)
        
        -- 清理所有功能
        if noclipActive then
            noclipActive = false
            noclipButton.Text = "穿墙"
        end
        
        if fastSpinActive then
            fastSpinActive = false
            fastSpinButton.Text = "快速旋转 (速度50)"
        end
        
        if ultraSpinActive then
            ultraSpinActive = false
            ultraSpinButton.Text = "极速旋转 (速度100)"
        end
        
        if infiniteJumpActive then
            infiniteJumpActive = false
            infiniteJumpButton.Text = "无限跳"
        end
        
        if drawPlayersActive then
            drawPlayersActive = false
            drawPlayersButton.Text = "显示绘制"
        end
        
        if outlineActive then
            outlineActive = false
            outlineButton.Text = "显示人物轮廓"
        end
        
        if nameTagsActive then
            nameTagsActive = false
            nameTagsButton.Text = "显示名字"
        end
        
        -- 清理ESP对象
        for _, objects in pairs(espObjects) do
            for _, obj in ipairs(objects) do
                if obj then
                    obj:Destroy()
                end
            end
        end
        
        -- 关闭所有连接
        for _, connection in pairs(getconnections(UserInputService.JumpRequest)) do
            connection:Disconnect()
        end
        
        screenGui:Destroy()
    end)
    
    screenGui.Parent = PlayerGui
    return screenGui
end

-- 初始化
SendChatMessage("欢迎使用南烛游戏助手", false)
SendChatMessage("这条消息只有您自己能看到", true)

-- 右下角提示
CreateNotification("脚本执行成功", 5)

-- 创建卡密系统
CreateKeySystem()
